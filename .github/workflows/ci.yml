name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-test-deploy:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-latest, windows-latest ]
        qt-version: [ '6.5.0' ]

    steps:
    # ===== SETUP =====
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ matrix.qt-version }}
        cached: true

    - name: Install dependencies
      run: |
        if [ "$RUNNER_OS" == "Linux" ]; then
          sudo apt-get update && sudo apt-get install -y build-essential
        else
          choco install cmake -y
        fi

    # ===== BUILD & TEST =====
    - name: Configure CMake
      run: cmake -B build -DENABLE_TESTS=ON

    - name: Build project
      run: cmake --build build --config Release

    - name: Run tests
      run: |
        cd build
        ctest --output-on-failure

    # ===== ARTIFACTS =====
    - name: List files for debugging
      run: ls -R build

    - name: Upload artifacts (Alternative Method)
      shell: bash
      run: |
        if [ "$RUNNER_OS" == "Linux" ]; then
          zip -r tictactoe-linux.zip build/
        else
          7z a tictactoe-windows.zip build/Release/
        fi
        curl -X POST \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Content-Type: application/zip" \
          --data-binary @tictactoe-$RUNNER_OS.zip \
          "https://uploads.github.com/repos/${{ github.repository }}/actions/artifacts?name=tictactoe-$RUNNER_OS"
